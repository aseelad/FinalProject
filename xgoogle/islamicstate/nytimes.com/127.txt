Waging Desperate Campaign, Iraqi Town Held Off Militants ...AMERLI, Iraq — The children lined the unkempt boulevard in this northern Iraqi town on Tuesday to welcome some of the men who had saved them from the Islamic State in Iraq and Syria.

Convoy after convoy of armed men raced past, blaring victory music from loudspeakers and bristling with weaponry. They waved as the young residents clapped and chanted religious slogans, celebrating the men who had broken the militants’ chokehold on Amerli and allowed in the first shipments of food and water in nearly three months.

It took an odd coalition of Iraqi and Iranian militias backed by American air support to drive off the ISIS fighters. But for long weeks before, the minority Shiite Turkmens who live here held the line, waging a desperate campaign for survival as they took up arms to protect the estimated 15,000 residents.

Amid daily shelling and at least four major assaults by ISIS, the people subsisted on onion soup and dry bread. Children joined the front lines during the day because there were not enough men for two shifts. Without gas, families cooked on open fires fueled by sheep dung.

The siege of Amerli is thought to be the first time a town has managed to keep the militants at bay since the group, which now calls itself the Islamic State, began its march through wide areas of Iraq. By Monday, aid from the United Nations had begun reaching the starving residents.

“The families in this village are so brave,” said Abu Abdullah, the commander of the Kataib Hezbollah militia that aided the residents. “There was no water, no electricity, no food and no milk for children, but they stood and fought ISIS.”

On Tuesday, the colorful flags of at least four militias competed for prominence on the streets and buildings of Amerli. Along with the banner of Kataib Hezbollah, an Iraqi group unrelated to the better-known Lebanese Hezbollah, were those of the Badr Brigades, Saraya al-Salam and Asaib Ahl al-Haq.

The fact that American air power had helped was not as celebrated. Some of the militiamen had fought the Americans after the invasion of Iraq in 2003. Mr. Abdullah spoke for many when he said, “We do not like the Americans, and we didn’t need their airstrikes.”

In a video released Tuesday, the killer of Steven J. Sotloff, an American journalist, made an apparent reference to the United States’ strikes near Amerli.

In Amerli, Mr. Abdullah said his men had arrived on Iraqi military helicopters about two weeks into the siege. They carried aid and weaponry, but also specialized skills. Among them were experts in communications, operations and explosives.

Mr. Abdullah said his forces had joined those inside Amerli to help beat back the ISIS militants. He refused to say how many of his fighters had assisted, to offer operational details or to expound on why his men had come at all. He said only that his troops were willing to take on the mission.

“Everyone heard the calls for help, but not everyone answered,” he said. “We answered.”

By the time the militias began arriving, ISIS had surrounded the town entirely. To the west, they were two kilometers away; to the east, just 500 meters. Residents had dug giant trenches in the mud around Amerli. Some had planted improvised explosive devices in the earth surrounding the town, hoping to keep ISIS out.

They had been planning for a long time. The day Mosul fell, tribal leaders in Amerli called a meeting in the town mosque to discuss their options, sure that the militants would eventually reach them, according to one of the leaders, Sheikh Shahab Ahmed Barash.

The men swore an oath on the Quran to protect the town. They would not flee as others had. The leaders began to divide the town into areas, typically by landmarks. One leader had the cemetery. Another had the tower.

ISIS made four major assaults on the town, sometimes with more than 100 men at a time and the benefit of armored vehicles.

But the biggest fight the residents of Amerli faced was against hunger, as the militants’ cordon kept supplies from entering.

During a series of interviews with commanders, several struggled to remember exact dates that major attacks had occurred. Ibrahim Hamid Ali, an elder in Amerli, believes the first assault began shortly after 6 p.m. on July 17, when the militants stormed the perimeter the residents had set up.

“We were told not to leave our positions,” said Mr. Barash, who controls an area in Amerli where about 200 families live. “If they broke through, then we would decide what to do.”

Mr. Barash and others said the fight lasted until dawn, when the Iraqi Air Force began to hit the areas under the militants’ control. The ISIS fighters slowly retreated, having been unable to breach the town, despite trying from multiple fronts.

For the next several weeks, Mr. Barash said, the militants studied the habits of the fighters for Amerli. They knew the town required boys to aid in the defense, but only during the day, when the youths could see the enemy.

On what residents believe was Aug. 5, the ISIS fighters struck at 4:30 a.m., just as Amerli’s defenders were switching to the day shift. The militants drove armored vehicles up to the mud berms, seizing a few houses on the edge of the city, according to Mr. Barash and Mr. Ali.

The account was substantiated by video footage from ISIS fighters who later abandoned those homes, leaving a flash drive that the Amerli fighters recovered.

The defenders of Amerli began fighting along the edge of the town. Members of Kataib Hezbollah fired mortars on the militants from inside the town. While ISIS had armored vehicles, so did some of the defenders, including members of the Iraqi military who had fled earlier but brought their Humvees with them and decided to aid Amerli.

The Iraqi Air Force at one point accidentally struck an area with Amerli fighters, residents said, wounding nine people. Eventually, after coordination with forces on the ground, they corrected and began striking areas farther from the town, residents said. By sunset, the militants began to retreat.

As they surveyed the area afterward, Mr. Barash encountered several bodies of ISIS fighters that the militants had not claimed. Standing over one, Mr. Barash heard a phone ring from inside the insurgent’s pocket. He grabbed the phone and spoke: “Come and take your body.”

But an old man answered, weeping. He told Mr. Barash that ISIS had taken his son from him when they swept through his village. The militants had given him a choice: He could give them his daughter or one of his sons.

Crying on the phone, the old man said his son was a teenager, not even old enough for facial hair, and never learned how to fight.

“I told him I was sorry,” Mr. Barash said.